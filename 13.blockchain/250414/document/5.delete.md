## 그럼 이제 다음은?

우리는 방금 `create()` 메서드를 만들어서  
트랜잭션 안의 **TxOut(출력)** 정보를 기반으로  
**새로운 잔액을 UTXO 목록에 등록**했습니다.

그런데 여기서 **아주 중요한 문제가 생깁니다.**

---

### 사용한 잔액이 아직 시스템에 그대로 남아 있다면?

트랜잭션이 생성되었다는 건

> **“나는 이전에 받은 이 돈을 써서 거래를 하겠다”**  
> 라고 선언한 것입니다.

그럼 이제 질문!

> ❓ "이전에 받은 그 돈(UTXO)은 어떻게 처리되어야 할까요?"

정답은 명확합니다.

> ✔️ **삭제되어야 합니다.**

---

## 왜 삭제해야 하나요?

UTXO(미사용 트랜잭션 출력)는  
블록체인에서 **한 번만 사용할 수 있는 잔액**이에요.

한 번 사용된 UTXO를 제거하지 않으면…

- 사용한 잔액이 계속 시스템에 남아 있게 되고
- 누군가가 **동일한 잔액을 또 사용하는 위조 트랜잭션을 만들 수 있게 됩니다**
- 결과적으로 **이중 지불(Double Spending)** 이 발생할 수 있어요

이건 블록체인 시스템이 절대 허용할 수 없는 상황입니다.

---

## 그래서 등장하는 게 `delate()` 메서드입니다

> **`delate()`는 사용된 TxIn을 기준으로, 기존 UTXO를 찾아서 목록에서 제거하는 메서드입니다.**

---

## 전체 코드

```ts
delate(txin: TxIn) {
  const { txOutId, txOutIndex } = txin;

  const index = this.unspentTxOuts.findIndex((unspentTxOut: UnspentTxOut) => {
    return (
      unspentTxOut.txOutId === txOutId &&
      unspentTxOut.txOutIndex === txOutIndex
    );
  });

  if (index !== -1) this.unspentTxOuts.splice(index, 1);
}
```

---

## 구조 설명

### 1. TxIn에서 필요한 정보 추출

```ts
const { txOutId, txOutIndex } = txin;
```

- 내가 사용하려는 잔액(UTXO)은  
  과거 어느 트랜잭션의 **몇 번째 출력**이었는지를 가리킵니다.

---

### 2. 해당하는 UTXO 찾기

```ts
const index = this.unspentTxOuts.findIndex((unspentTxOut) => {
  return (
    unspentTxOut.txOutId === txOutId && unspentTxOut.txOutIndex === txOutIndex
  );
});
```

- 전체 UTXO 목록에서
- 내가 사용하겠다고 선언한 TxIn에 **정확히 해당하는 항목**을 찾습니다.

---

### 3. 찾았다면 제거하기

```ts
if (index !== -1) this.unspentTxOuts.splice(index, 1);
```

- `splice()`를 통해 해당 항목을 배열에서 제거합니다.
- 이로써, **이미 사용한 잔액은 더 이상 사용할 수 없게** 됩니다.

---

## 흐름 예시

### 현재 UTXO 목록:

```ts
[
  { txOutId: "aaa", txOutIndex: 0, account: "A", amount: 10 },
  { txOutId: "bbb", txOutIndex: 0, account: "B", amount: 20 },
];
```

### 트랜잭션의 TxIn:

```ts
{ txOutId: "aaa", txOutIndex: 0 }
```

`delate()` 실행 결과:

```ts
[{ txOutId: "bbb", txOutIndex: 0, account: "B", amount: 20 }];
```

---

## 언제 실행되나요?

```ts
update(transaction: TransactionRow) {
  const { txIns, txOuts, hash } = transaction;

  txOuts.forEach(this.create(hash)); // 새로운 잔액 등록
  txIns.forEach(this.delate.bind(this)); // 사용한 잔액 제거
}
```

트랜잭션이 블록에 포함될 때:

- 새롭게 생긴 `txOuts`는 → UTXO에 등록 (`create`)
- 사용한 `txIns`는 → UTXO에서 제거 (`delate`)

---

## 정리 요약

| 단계 | 설명                                                           |
| ---- | -------------------------------------------------------------- |
| 1    | TxIn에서 어떤 UTXO를 사용했는지 파악 (`txOutId`, `txOutIndex`) |
| 2    | 현재 UTXO 목록에서 해당 항목을 찾아 index 추출                 |
| 3    | 해당 항목이 존재하면 `splice()`로 제거                         |
