# Entity – 이 시스템 안의 주체들은 누구일까요?

지금 우리가 구현하고 있는 메타 트랜잭션 시스템은  
그냥 “버튼 누르면 실행되는 시스템”이 아닙니다.  
**책임이 분리된 여러 주체들이 서로 협력하는 구조**입니다.

Ethereum의 계정 추상화(Account Abstraction)는  
**사용자와 계정의 개념 자체를 다시 설계**하려는 실험입니다.  
그 안에는 여러 **주체(entity)**들이 존재하며,  
각자 다른 책임을 지고 움직입니다.

## 1. 사용자 (User)

사용자는 이렇게 말합니다:

> "나 이거 원해요. 근데 제가 직접 하긴 어렵습니다."

그래서 사용자는

- 트랜잭션을 직접 보내지 않고,
- 단지 **“이 행동을 승인합니다”**라는 메시지에 서명합니다.
- 서명된 메시지는 사용자 의사를 증명하는 서류처럼 작동합니다.

이 사용자는  
**개인키를 가진 EOA일 수도 있고**,  
**시스템에 의해 만들어진 스마트 계정일 수도 있습니다.**  
중요한 건, **실행은 하지 않고 책임만 서명으로 남긴다는 것**입니다.

## 2. 서버 (검증자 + 저장소 관리자)

서버는 사용자의 메시지를 받으면 이렇게 합니다:

> “정말 이 서명이 이 사람의 것 맞아?”  
> “서명이 올바르면, 저장해둘게요.”

서버는 다음 역할을 수행합니다:

- 사용자의 메시지(JSON)와 서명(signature)을 받아
- `verifyMessage()`로 복원 주소를 확인하고
- 올바른 요청만 `txpool`에 저장합니다

여기서의 `txpool`은 네트워크 mempool이 아닙니다.  
**우리가 만든 임시 저장소**입니다.  
즉, **검증된 사용자 요청이 모여 있는 대기 공간**입니다.

## 3. 회사 지갑 (Bundler 역할, 실행자)

이 주체가 진짜 중요합니다.  
회사 지갑은 다음과 같이 행동합니다:

> “좋아, 이 요청들 내가 책임지고 실행할게.”  
> “가스비도 내가 낼게. 대신 서명이 진짜여야 해.”

이건 현실의 서비스 제공자(플랫폼)와 매우 유사합니다.

회사 지갑은 다음을 수행합니다:

- `txpool`에서 요청들을 읽고
- 각각의 메시지와 서명을 컨트랙트에 전달하여
- **컨트랙트 내부에서 `ecrecover()`로 서명 검증을 시도하게 하고**
- 검증에 통과된 요청만 실행되도록 합니다

즉, 회사 지갑은 **대납자이자 실행 책임자**입니다.  
Ethereum 구조에서 이 역할을 **Bundler**라고 부릅니다.

## 4. 스마트 컨트랙트 (`metaTransaction.sol`)

이 컨트랙트는 단순 실행기가 아닙니다.  
컨트랙트는 이렇게 생각합니다:

> “아무 요청이나 받으면 안 돼.  
> 서명이 맞는지 내가 직접 검증해보고,  
> 진짜 사용자의 의사일 때만 실행할 거야.”

컨트랙트는 다음과 같은 역할을 수행합니다:

- 사용자 지갑 주소와 서명값을 받아
- `getEthSignMsgHash()`로 해시를 만들고
- `splitSign()`으로 서명값을 r, s, v로 분해하고
- `ecrecover()`로 복원한 주소가 user와 일치하면
- `MyToken.mint()`를 호출해 토큰을 발행합니다

이 컨트랙트는 **EntryPoint 구조의 역할을 시뮬레이션**하고 있습니다.  
즉, **검증자이자 실행 허가자**입니다.

## 5. Paymaster (가스비 대납자)

현재 구현에는 포함되지 않았지만,  
ERC-4337의 구조에는 **Paymaster**라는 주체도 등장합니다.

이 주체는 말 그대로,

> “조건이 맞으면 내가 대신 가스비를 내줄게요.”  
> “하지만 아무 요청이나 받진 않을 거예요.”

예를 들어:

- 특정 NFT를 가진 사람만 가스비를 지원한다든지,
- 어떤 앱에서 최초 1회는 무료로 해준다든지

이런 조건부 대납 구조를 **Paymaster**가 처리합니다.

## 정리 – 이 구조는 하나의 “협업 시스템”입니다

우리가 지금 작성하고 있는 시스템은  
단순한 백엔드 API가 아닙니다.

**사용자 → 서버 → 실행자 → 컨트랙트**로 이어지는  
**위임과 검증의 흐름**,  
**책임과 신뢰의 분리 구조**를 실험하고 있는 것입니다.

> “Web3는 트랜잭션 하나가 아니라,  
> 책임을 나누는 구조 그 자체다.”

이 철학을 이해하고  
각 주체가 어떤 책임을 지는지 기억하며  
이후 흐름을 따라가 봅시다.
