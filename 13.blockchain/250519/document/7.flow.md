# 구조적 흐름 – 우리가 구현할 메타 트랜잭션 시스템

자, 여러분.
이제 이론은 어느 정도 정리됐습니다.

우리는 지금까지

- Ethereum의 기존 구조(EIP-155)가 가진 한계,
- 그걸 극복하기 위한 철학인 계정 추상화,
- 그리고 그 철학을 구조화한 **ERC-4337의 5대 구성 요소**

까지 배웠습니다.

그럼 이제 진짜로
“우리는 어떤 구조를 직접 구현하게 될 것인가?”
를 이야기할 차례입니다.

---

> 지금부터 우리는
> **실제 메타 트랜잭션 구조**를 코드로 따라가며 하나하나 만들 겁니다.

그런데 그 전에,
**전체 흐름을 먼저 그려두는 게 좋겠죠.**

## 우리가 구현할 구조는 이런 흐름입니다

### 1. 사용자 요청 단계 (프론트엔드)

사용자는 토큰을 받고 싶습니다.
**원래라면, 트랜잭션을 직접 날릴 수 있는 EOA 지갑도 가지고 있습니다.**
하지만, **이번 구조에서는 의도적으로 그 권한을 사용하지 않습니다.**

---

왜냐하면, 우리가 지금부터 만들 구조는  
**“트랜잭션을 직접 날릴 수 없는 사용자도 Web3를 쓸 수 있게 만드는 것”**을  
실현해보기 위한 흐름이기 때문입니다.

- 프론트에서 입력을 받고
- **"나 토큰 몇 개 받고 싶어요"**라는 메시지를 작성합니다.
- 그리고 그 메시지를 **자신의 개인 키로 서명**합니다.

✔️ 이 메시지는 실제 트랜잭션은 아니지만,  
**“나는 이 행동을 원합니다”라는 인증된 요청서**입니다.  
즉, **`UserOperation`과 유사한 구조**를 만듭니다.

---

### 3. 회사지갑 실행 단계 (회사 Bundler 역할)

- 일정 시간이 지나거나,
- 관리자가 버튼을 누르면,
- 회사지갑이 **txpool에 쌓인 요청들을 읽고**,
- **한 번에 실행**합니다.

---

여기서 여러분에게 꼭 설명드려야 할 것이 있습니다.

> **“txpool”이라는 단어, 낯익지 않나요?**

제가 **비트코인 네트워크 구현 수업** 때 설명한 적 있죠?

> **txpool = 트랜잭션 저장소**
> → 블록에 아직 포함되지 않은 트랜잭션들이 대기 중인 공간

하지만,
**지금 우리가 말하는 `txpool`은 그와는 다릅니다.**

---

### ⚠️ 지금 여기서 말하는 `txpool`은?

> **“내가 따로 만든, 사용자 요청 임시 저장소”입니다.**

즉, Ethereum이나 Bitcoin 노드가 관리하는
**네트워크 수준의 글로벌 mempool**이 아니라,
**우리 서버가 임의로 보관하고 있는 나만의 요청 보관소**입니다.

---

| 구분                        | 설명                                              |
| --------------------------- | ------------------------------------------------- |
| **1. 네트워크 mempool**     | 모든 노드가 공유함, 실제 트랜잭션이 들어감        |
| **2. 우리 시스템의 txpool** | 아직 트랜잭션이 아님. 사용자 서명된 요청을 저장함 |

우리는 이 “나만의 txpool”에서
사용자들이 서명한 요청들을 모아서
**한 번에 컨트랙트로 전달**하는 구조를 실습할 것입니다.

✔️ 이때 호출되는 스마트 컨트랙트가
바로 **ERC-4337에서의 `EntryPoint` 역할을 흉내내는 구조**입니다.

---

### 4. 컨트랙트 실행 단계 (mint 함수)

- 회사 지갑이 한꺼번에 받은 요청들을
  **스마트 컨트랙트에 전달하면**,
- 각 요청에 맞게 **토큰을 mint하거나**
- **검증 후 실행되게 됩니다.**

## 구조 요약 도식

```plaintext
[사용자 지갑]
    ↓ signMessage()

[프론트엔드]
    ↓ POST

[백엔드 txpool]
    ↓ /metaTransaction

[회사 지갑 (Bundler)]
    ↓

[스마트 컨트랙트 mint()]
```

---

### 흐름을 따라가며,

우리는 다음을 실습하게 됩니다:

1. 메시지를 만들어 서명하는 법
2. 백엔드에서 서명된 메시지를 검증하는 법
3. 여러 메시지를 모아서 한 번에 처리하는 법
4. 가스비를 사용자가 내지 않고도 트랜잭션을 실행하는 법

---

> 그리고 중요한 건,
> 이 전체 구조가 **실제 ERC-4337 구조와 거의 일치한다**는 점입니다.

- 우리는 지금
  `UserOperation`을 직접 다루진 않지만,
  그와 **거의 유사한 구조를 코드로 따라가게 될 것**입니다.

## 설명 책임 안내

이 구조는 오늘부터 여러분이
직접 손으로 구현하게 될 **전체 그림의 설계도**입니다.

지금은 그냥 전체 흐름을 감 잡는 정도면 됩니다.

> 아래 단락들에서 이 흐름을
> **하나씩 코드로 분해하고, 직접 체험하게 됩니다.**
