# 개념 구조 – ERC-4337의 5대 구성 요소

자, 이제 우리는  
**계정 추상화라는 철학과 필요성**,  
그리고 Ethereum이 왜 이 구조를 다시 짜야 했는지를 충분히 살펴봤습니다.

그렇다면 이제 질문을 바꿔야 합니다.

> “좋아, 계정을 추상화하고 싶어.
> 그런데 **어떻게 구현하지?**”

우리가 지금까지 이야기한 건  
전부 ‘이상적인 그림’이었습니다.

- 컨트랙트도 계정처럼 행동하고,
- 서명 방식도 자유롭게 바꾸고,
- 가스비도 누군가 대신 내주고…

그런데 이런 이상적인 모습을 만들기 위해서는  
**어떤 기준과 구조**가 필요합니다.

## 그래서 Ethereum 커뮤니티는 다음과 같은 기준을 정합니다:

“우리가 지금 구조를 바꾸되,  
Ethereum의 합의 계층은 건드리지 말자.”  
“프로토콜은 그대로 두고,  
그 위에서 **추상화된 계정 시스템**을 인프라 수준에서 구성하자.”

이 기준을 토대로 등장한 것이 바로

## **ERC-4337 구조의 5대 요소**입니다.

Ethereum에서 기존의 계정 모델(EIP-155 트랜잭션 구조)을 유지하면서,  
추상화된 계정 구조를 실현하기 위한 **인프라 아키텍처**죠.

## 이 다섯 가지가 바로 핵심입니다:

### 1. `UserOperation`

> 트랜잭션을 대체하는 새로운 “요청 객체”

- 기존의 `transaction`은 EOA만 생성 가능했죠?
- 이제는 **컨트랙트 계정도 요청을 낼 수 있게**
  → `UserOperation`이라는 새로운 객체 구조가 등장합니다.

이 객체에는

- 발신자 주소,
- 실행할 데이터,
- 가스비 지불 방식,
- 서명 등
  모든 정보가 들어 있습니다.

> 쉽게 말해, “이걸 실행해줘요”라는 **행동 요청서**입니다.

### 2. `Bundler`

> 여러 UserOperation을 모아서 블록체인에 보내는 역할

기존의 트랜잭션은 EOA가 직접 블록에 전송했습니다.  
하지만 UserOperation은 그냥 바로 체인에 올라가는 게 아니라,  
**중간에서 모아주는 주체가 필요합니다.**

> 그게 바로 Bundler입니다.

- UserOperation을 **새로운 mempool**에서 수집하고
- **검증**을 거친 뒤
- 하나의 트랜잭션으로 **EntryPoint 컨트랙트에 전달**합니다.

> 마치 택배 회사가 여러 주문서를 한 박스에 담아 물류센터에 보내는 것처럼요.

### 3. `EntryPoint`

> Bundler가 전달한 요청을 실행하는 핵심 컨트랙트

<!-- metaTransaction.sol -->

- 모든 UserOperation은 결국 이 EntryPoint로 보내져서 실행됩니다.
- EntryPoint는 받은 요청을
  → 각 계정(컨트랙트 계정)의 로직에 따라 실행하게 합니다.

> 모든 추상화된 계정들의 **공통 진입점**

즉, 실제로 Ethereum에서 **“추상화된 트랜잭션”을 처리하는 문지기** 역할을 합니다.

> 이 안에서 `handleOps()`라는 함수가 핵심 역할을 합니다.
> 이 함수는 우리가 후속 단락에서 코드로 직접 살펴보게 됩니다.

### 4. `Paymaster`

> 사용자의 가스비를 대신 내주는 구조

> “사용자는 가스비를 몰라도 된다.”
> → 이걸 현실화하는 주체가 바로 Paymaster입니다.

- 사용자가 UserOperation을 제출할 때,
- **가스비를 본인이 내는 게 아니라**
- 지정된 Paymaster가 **검증 후 대납**합니다.

예를 들어:

- 게임 회사가 자사 유저의 첫 트랜잭션은 대신 내주고 싶을 때
- 특정 조건(예: NFT 보유 여부)에 따라 가스비를 지원할 때

> 이 구조는 우리가 나중에 실제 코드로 구현하며 직접 실험해보게 됩니다.

### 5. `EIP-1271`

> 스마트 컨트랙트가 서명을 검증할 수 있도록 해주는 표준

> “컨트랙트는 서명할 수 없다.”
> → 그 말은 맞지만,
> → 컨트랙트가 **서명한 척하고, 대신 검증**할 수는 있습니다.

EIP-1271은 바로 그걸 위한 표준입니다.

- 컨트랙트가 특정 메시지에 대해
  “이건 내가 승인한 거야”라는 로직을 작성할 수 있도록 합니다.
- 즉, **서명을 위임하거나**,
  **다중 조건 서명 로직**을 구성할 수 있게 됩니다.

예:

- 소셜 로그인 기반 서명
- 2-of-3 멀티시그
- 시간 조건이 붙은 승인

> 이것도 우리가 후속 단락에서 다룰 **Paymaster + Signature 검증** 코드 흐름에서 확인하게 됩니다.

## 정리

해당 설계도는 다음 다섯 가지 요소로 완성됩니다:

| 구성 요소       | 핵심 역할                            |
| --------------- | ------------------------------------ |
| `UserOperation` | 새로운 트랜잭션 객체 (사용자 요청서) |
| `Bundler`       | 요청 수집 및 전달자                  |
| `EntryPoint`    | 요청 실행의 관문 컨트랙트            |
| `Paymaster`     | 가스비 대납 기능                     |
| `EIP-1271`      | 서명 방식의 유연화 표준              |

---

⚠️ 이 단락에서는 구조와 개념만 다룹니다.
실제 `handleOps()` 함수, Paymaster 코드, 서명 검증 등은
후속 단락에서 **직접 코드로 구현하며** 체험하게 됩니다.
