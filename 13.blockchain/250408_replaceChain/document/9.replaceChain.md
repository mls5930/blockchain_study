# 9.replaceChain.md

## 체인을 교체하기 전에 반드시 체크해야 할 조건들

## 질문부터 시작해볼게요

> 상대방이 체인을 보내줬어요.  
> 무작정 바꾸면 안 되겠죠?

→ 바꾸기 전에 먼저 **이 체인이 바꿀 ‘자격’이 되는지** 확인해야 합니다.

## 핵심은 딱 두 가지

1. 상대방 체인이 **너무 짧거나**,
2. **아직 제네시스 블록밖에 없다면**

→ ❌ 바꾸면 안 됩니다.

---

## 실제 코드 흐름 분석

```ts
const latestReceivedBlock = receivedChain[receivedChain.length - 1];
const latestBlock = this.latestBlock();
```

- `latestReceivedBlock`: 상대방 체인의 마지막 블록
- `latestBlock`: 내 체인의 마지막 블록

---

### 1. 상대방 체인이 제네시스 블록밖에 없는 경우

```ts
if (latestReceivedBlock.height === 0) {
  return {
    isError: true,
    message: "상대방의 체인은 마지막 블록이 최초 블록이다.",
  };
}
```

> ❗ 제네시스 블록만 있다는 건 = 아직 **체인이 구성되지 않았다**는 뜻  
> → **교체할 이유가 없다** → 그냥 무시

---

### 2. 상대방 체인이 **내 체인보다 짧거나 같을 경우**

```ts
if (latestReceivedBlock.height <= latestBlock.height) {
  return {
    isError: true,
    message: "상대방의 체인이 내 체인보다 짧거나 같다.",
  };
}
```

> ❗ 롱기스트 체인 룰의 핵심은 **"더 긴 체인만 교체한다"**  
> → 내 체인보다 짧거나 같다면?  
> → 역시 무시합니다.

---

## 여기서 이해해야 할 개념 정리

| 체크 조건                          | 설명                                               | 교체 여부  |
| ---------------------------------- | -------------------------------------------------- | ---------- |
| `height === 0`                     | 제네시스 블록밖에 없는 체인                        | ❌ 안 바꿈 |
| `height <= 내 체인`                | 길이가 짧거나 같음                                 | ❌ 안 바꿈 |
| `height > 내 체인` (다음 단계에서) | 이 조건 통과하면 → 유효성 검사 후 교체 가능성 있음 | ✅ 고려함  |

## 교체 여부 판단의 기준은?

> 단순히 "길다"고 무조건 바꾸지 않아요.  
> **길이 → 유효성 → 전체 교체**  
> 이 3단계를 반드시 모두 통과해야 교체됩니다.

## 다음은?

→ 이 조건들을 통과한 체인만  
→ **유효성 검증**을 거쳐서  
→ **진짜 교체할지 결정**하게 됩니다.

즉, 이 코드는 `replaceChain()`의 **1차 필터 단계**입니다.
