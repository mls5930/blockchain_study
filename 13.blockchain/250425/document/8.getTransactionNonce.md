# **nonce: 우리가 직접 다뤄야 할 때**

## 어제 실습 기억나죠?

`reset()` 함수를 만들어서  
직접 카운터를 0으로 되돌리는 트랜잭션을 날려봤습니다.

그 과정에서 우리는 MetaMask를 통해  
**블록체인 네트워크에 직접 요청을 보냈습니다.**

### 그런데... 어떻게 가능했을까요?

MetaMask는 설치되자마자  
브라우저에 `window.ethereum`이라는 객체를 주입해줍니다.

그래서 우리는 다음과 같은 코드를 썼죠:

```js
const web3 = new Web3(window.ethereum);
```

이 순간,  
MetaMask는 **사용자의 계정**과  
**연결된 RPC 노드**를 web3 인스턴스에 자동으로 연결해줍니다.

## 평소엔 누가 nonce를 관리할까?

바로 이 **MetaMask나 연결된 RPC 노드**가  
`nonce`를 자동으로 추적하고 설정해줍니다.

예를 들어:

```js
const nonce = await web3.eth.getTransactionCount(address);
// 또는 send() 내부에서 자동으로 처리됨
```

> 그래서 대부분의 경우,  
> 우리가 직접 nonce를 신경 쓰지 않아도  
> 트랜잭션이 잘 보내지고, 잘 실행됩니다.

## 그런데… 항상 자동이면 좋겠지만?

그렇지 않을 때가 있습니다.

## 1. **비동기 트랜잭션을 연속으로 날릴 때**

```js
for (let i = 0; i < 3; i++) {
  contract.methods.increment().send({ from: account });
}
```

이렇게 보내면 어떻게 될까요?

→ 세 개의 트랜잭션이 **동시에 생성**되는데,  
→ 모두 `nonce=0`을 참조할 수 있어서  
→ **충돌이 발생하거나, 하나만 처리되고 나머지는 실패**합니다.

## 2. **트랜잭션이 pending 상태로 오래 남아있을 때**

- 내가 `nonce=5`인 트랜잭션을 보냈습니다.
- 그런데 가스비가 낮아서 블록에 잘 포함되지 않아요.
- 그 상태에서 `nonce=6`을 보내면?

### 이럴 때 우리는 어떻게 해야 할까?

- `nonce=5`인 트랜잭션을 **gasPrice를 높여 다시 보내거나**
- **nonce=5를 명시하여 재정렬**해줘야 합니다.

## 그래서 필요한 게 바로 "수동 nonce 지정"입니다.

## 직접 지정하는 방법

```js
const nonce = await web3.eth.getTransactionCount(address, "latest");

contract.methods.reset().send({
  from: address,
  gas,
  gasPrice,
  nonce, // 👈 수동 지정
});
```

## 어떤 상황에서 이게 필요할까?

| 상황                                          | 설명                                                  |
| --------------------------------------------- | ----------------------------------------------------- |
| 여러 트랜잭션을 순서대로 미리 생성할 때       | 각각의 nonce를 수동으로 설정해야 충돌 없이 실행됨     |
| 가스비 재설정 트랜잭션 보낼 때                | 동일 nonce로 전송하여 이전 트랜잭션을 대체하려는 경우 |
| 지갑 없이 Node.js 환경에서 트랜잭션 생성할 때 | 자동 추적이 안 되므로 직접 설정 필요                  |

---

## 실습 예시: 우리가 했던 `reset()` 코드

```js
const nonce = await web3.eth.getTransactionCount(address);
const tx = await contract.methods.reset().send({
  from: address,
  gas,
  gasPrice,
  nonce,
});
```

→ 여기서 `nonce`는 우리가 명시적으로 지정한 값입니다.

> “지금 이 계정이 n번째 트랜잭션을 보내고 있다”  
> 라는 걸 확실하게 선언한 것이죠.

## 마지막 요약

| 항목      | 내용                                                                   |
| --------- | ---------------------------------------------------------------------- |
| 기본 상황 | MetaMask나 RPC가 자동으로 nonce를 계산해줌                             |
| 예외 상황 | 연속 트랜잭션, pending, 커스텀 송신 등에서는 직접 지정이 필요함        |
| 핵심 역할 | 순서 보장, 충돌 방지, 트랜잭션 교체 등에서 **신뢰 가능한 기준점**이 됨 |

## 결론

> **nonce는 단순한 번호표가 아닙니다.**  
> 이더리움 네트워크에서  
> **"이 요청이 언제, 어떻게, 어떤 순서로 처리되어야 하는가"**를  
> 결정하는 핵심 장치입니다.
