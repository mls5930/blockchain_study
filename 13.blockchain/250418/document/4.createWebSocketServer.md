# 2단계: `createWebSocketServer(server, chain)` – 실시간 전파 준비하기

---

## 1단계에서 우리는 뭘 했죠?

> `http.createServer(app)` 으로  
> **브라우저가 접근할 수 있는 HTTP 서버**를 만들었어요.

그리고 기억나시죠?

> WebSocket은 HTTP 위에 붙는 구조라고요.  
> 그래서 이제 WebSocket을 붙일 차례입니다.

---

## 그런데… 왜 WebSocket에 `chain`을 넘겨줘요?

우리가 하려는 건 단순히 "연결"이 아닙니다.

> **“이 체인이 바뀌었어요!”**  
> 라는 **이벤트를 실시간으로 알려주는 구조**를 만들고 싶은 거예요.

---

## 그럼 정리해봅시다. 우리는 뭘 원하죠?

### 목표 리스트

| 하고 싶은 일                                     | 코드로 표현하면?                       |
| ------------------------------------------------ | -------------------------------------- |
| 1. 브라우저가 서버에 WebSocket으로 연결함        | `on("connection")`                     |
| 2. 연결되면, 지금의 체인 상태를 알려줌           | `ws.send(init 체인)`                   |
| 3. 체인이 바뀌면, 실시간으로 브라우저에게 알려줌 | `chain.on("chainUpdated") → ws.send()` |

---

## 그래서 `createWebSocketServer(server, chain)` 함수가 필요합니다

```ts
createWebSocketServer(server, chain);
```

이 한 줄은 이렇게 해석돼요:

> **“이 HTTP 서버 위에 WebSocket 서버를 붙이고,  
> 체인이 바뀌면 자동으로 브라우저에 알려줘.”**

---

## 왜 `chain`이 꼭 필요할까?

WebSocket은 단순한 연결만 해주는 게 아니에요.  
우리는 **“체인이 바뀌면 자동으로 감지하고 → 연결된 브라우저에게 보내야”** 해요.  
그걸 하려면 `chain` 내부에서 무슨 일이 일어나는지를 알아야겠죠?  
그래서 `chain` 객체를 넘겨주는 겁니다.

## 실제 흐름은 이래요

1. WebSocket 연결이 생김 (`ws`)
2. 연결된 순간 → `chain.get()`으로 현재 체인을 보내줌
3. 이후에 누군가 블록을 생성함 → `chain`이 바뀜
4. `chain.emit("chainUpdated")` 발생
5. WebSocket 서버가 그걸 감지하고 `ws.send()`로 브라우저에게 알려줌

## 시각적으로 정리하면 이렇게 됩니다

```
HTTP 서버 (server)
  └── WebSocket 서버
        ├── 연결되면: 현재 체인 전송
        └── 체인 변경되면: 자동 전파 (이벤트 기반)
```

## 요약 정리

| 개념                                   | 설명                                                                  |
| -------------------------------------- | --------------------------------------------------------------------- |
| `server`                               | HTTP 서버, WebSocket이 붙을 기반                                      |
| `chain`                                | 실시간으로 업데이트되는 블록체인 데이터                               |
| `createWebSocketServer(server, chain)` | 연결과 동시에 체인을 보내고, 변경 사항을 실시간 전파할 수 있도록 설정 |

## 마지막 한 줄 요약

> **"이 한 줄이, 체인의 실시간 반영을 가능하게 만드는 첫 연결점이다."**  
> 지금은 단순한 연결처럼 보이지만,  
> 이게 **“변화가 생기면 자동으로 알려주는 구조”**의 시작입니다.
