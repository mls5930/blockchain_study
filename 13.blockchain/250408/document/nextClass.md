## 체인 비교

replaceChain

### 왜 필요한가?

실제 블록체인은 여러 노드가 서로 다른 체인을 갖고 있을 수 있습니다.  
그렇다면 다음과 같은 문제가 발생합니다:

> **"내 체인보다 상대방 체인이 더 길어요. 그럼 내 체인을 바꿔야 할까?"**

이럴 때 사용되는 원칙이 바로:

> **롱기스트 체인 룰(Longest Chain Rule)**  
> 가장 긴 체인이 정답이다!

---

### 우리가 구현할 방식

우리는 단순한 토이 블록체인이기 때문에,  
**난이도 총합 대신 "길이"만 기준으로 비교**합니다.

실제 비트코인에서는 더 복잡한 비교(작업량 총합)이나  
우리는 다음과 같은 조건으로 구현합니다:

- 상대 체인의 마지막 블록 높이 > 내 체인 → 교체
- 그렇지 않으면 무시
- 체인의 유효성 검사는 생략하거나 추후 확장 가능

## 매개변수 설명

```ts
replaceChain(receivedChain: Block[]): { isError: boolean; value: string }
```

### `receivedChain: Block[]`

> 다른 노드(또는 외부)로부터 받은 새로운 체인입니다.

이 매개변수는 다음을 전제로 합니다:

- **네트워크에서 받은 체인**일 수 있습니다. (예: WebSocket, P2P 네트워크)
- **내가 가진 체인보다 더 길고**,
- **올바르게 연결되어 있어야(valid)**,
- **현재 내 체인을 교체할 수 있는 후보**입니다.

### 왜 이게 필요한가요?

블록체인은 네트워크 환경에서 각 노드가 서로 체인을 교환하며  
**"누가 더 신뢰할 수 있는 체인을 가졌는가"**를 비교합니다.  
이때 받은 체인을 기준으로 교체 여부를 결정하기 위해 이 인자가 필요합니다.

## 반환값 설명

```ts
{
  isError: boolean;
  value: string;
}
```

| 속성      | 설명                                |
| --------- | ----------------------------------- |
| `isError` | 교체 실패 여부 (`true`면 오류 발생) |
| `value`   | 성공 또는 실패 메시지 (이유 설명용) |

### 반환 예시

| 상황                 | 반환값                                                              |
| -------------------- | ------------------------------------------------------------------- |
| 체인이 유효하지 않음 | `{ isError: true, value: "유효하지 않은 체인입니다." }`             |
| 체인이 짧음          | `{ isError: true, value: "받은 체인이 기존보다 짧거나 같습니다." }` |
| 교체 성공            | `{ isError: false, value: "체인 교체 완료!" }`                      |

## 전체 요약

| 항목            | 설명                                  |
| --------------- | ------------------------------------- |
| `receivedChain` | 교체 대상으로 받은 외부 체인          |
| `isError`       | 교체에 실패했는지 여부                |
| `value`         | 실패 또는 성공 이유를 설명하는 메시지 |

## 자 리스트를 작성해봅시다.

### 체인을 교체할 것인가? `replaceChain()` 로직 설명

이 함수는 **외부에서 받은 체인(receivedChain)** 을  
**현재 내 체인(this.chain)** 과 비교해서  
**교체할지 말지를 결정**합니다.

---

### 로직 순서 요약

1. ✅ **상대방 체인의 마지막 블록을 가져온다**
2. ✅ **내 체인의 마지막 블록을 가져온다**
3. ✅ **체인의 길이를 비교한다**
4. ❌ **상대방 체인이 제네시스 블록만 있을 경우 → 에러**
5. ❌ **상대방 체인이 나보다 짧거나 같을 경우 → 에러**
6. ✅ **상대방 체인이 더 길다면 → 내 체인을 교체한다**

---

## 코드 + 설명

```ts
replaceChain(receivedChain: Block[]): { isError: boolean; value: string | undefined } {
  // 1. 상대방 체인의 마지막 블록을 가져온다
  const lastReceivedBlock: Block = receivedChain[receivedChain.length - 1];

  // 2. 내 체인의 마지막 블록을 가져온다
  const latestBlock: Block = this.latestBlock();

  // 3. 상대방 체인이 제네시스 블록밖에 없다면? → 교체 불가
  if (lastReceivedBlock.height === 0) {
    return { isError: true, value: "상대방 체인은 제네시스 블록밖에 없습니다." };
  }

  // 4. 상대방 체인이 내 체인보다 짧거나 같다면? → 무시
  if (lastReceivedBlock.height <= latestBlock.height) {
    return { isError: true, value: "상대방 체인이 현재 체인보다 짧거나 같습니다." };
  }

  // 5. 여기까지 왔다면 → 상대방 체인이 더 길다는 뜻! → 교체 진행
  this.chain = receivedChain;
  return { isError: false, value: undefined };
}
```

---

## 왜 이런 조건이 필요한가요?

| 조건                     | 이유                                                            |
| ------------------------ | --------------------------------------------------------------- |
| 제네시스 블록만 있다면?  | 유효한 체인이라고 보기 어렵기 때문입니다                        |
| 길이가 짧거나 같다면?    | 블록체인에서는 **더 길고 유효한 체인**을 따라야 하기 때문입니다 |
| 상대방 체인이 더 길다면? | 이론적으로 더 많은 작업이 들어간 체인 → 신뢰 가능성이 높음      |

---

### 반환 형식 설명

```ts
{
  isError: boolean; // 에러 발생 여부
  value: string | undefined; // 상태 메시지 (성공 시 생략 가능)
}
```

- `true`: 에러 발생 → 교체 실패
- `false`: 정상 처리 → 체인 교체 완료
- `value`: 실패/성공 이유를 문자열로 명시
